<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSV Image Processor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body class="bg-light">

    <div class="container mt-5">
        <h2 class="text-center">CSV Image Processing</h2>

        <!-- File Upload Form -->
        <div class="card p-4 shadow">
            <h4>Upload CSV File</h4>
            <form id="uploadForm">
                <div class="mb-3">
                    <input type="file" id="csvFile" class="form-control" required>
                </div>
                <div class="mb-3">
                    <input type="text" id="webhookUrl" class="form-control" placeholder="Enter Webhook URL (Optional)">
                </div>
                <button type="submit" class="btn btn-primary">Upload</button>
            </form>
            <p id="uploadStatus" class="mt-3 text-success"></p>
        </div>

        <!-- Check Status Section -->
        <div class="card p-4 shadow mt-4">
            <h4>Check Processing Status</h4>
            <div class="mb-3">
                <input type="text" id="requestId" class="form-control" placeholder="Enter Request ID">
            </div>
            <button id="checkStatus" class="btn btn-success">Check Status</button>
            <p id="statusResult" class="mt-3"></p>
        </div>

        <!-- Webhook Log -->
        <div class="card p-4 shadow mt-4">
            <h4>Webhook Status</h4>
            <p id="webhookLog" class="text-info">No webhook triggered yet.</p>
        </div>
    </div>

    <script>
        $(document).ready(function () {
    $("#uploadForm").submit(function (e) {
        e.preventDefault();

        let file = $("#csvFile")[0].files[0];
        let webhookUrl = $("#webhookUrl").val();
        let formData = new FormData();
        formData.append("file", file);
        formData.append("webhook_url", webhookUrl);

        $.ajax({
            url: "http://127.0.0.1:5000/upload", // Ensure the correct backend URL
            type: "POST",
            data: formData,
            contentType: false,
            processData: false,
            success: function (response) {
                console.log("Response from server:", response); // Debugging
                if (response.request_id) {
                    $("#uploadStatus").html(
                        `<strong>Upload Successful!</strong> Request ID: 
                        <b>${response.request_id}</b>`
                    );
                    $("#requestId").val(response.request_id); // Autofill request ID field
                } else {
                    $("#uploadStatus").html("Upload successful, but no request ID received.");
                }
            },
            error: function (xhr, status, error) {
                console.error("Upload error:", xhr.responseText);
                $("#uploadStatus").html("Error Uploading File. Please try again.");
            }
        });
    });
});


            // âœ… Handle Status Check
            $("#checkStatus").click(function () {
                let requestId = $("#requestId").val();
                if (requestId === "") {
                    alert("Please enter a request ID.");
                    return;
                }

                $.ajax({
                    url: "http://127.0.0.1:5000/status/" + requestId,
                    type: "GET",
                    success: function (response) {
                        if (response.status === "Completed") {
                            $("#statusResult").html(`<b>Status:</b> ${response.status} <br> <b>Output File:</b> <a href="${response.output_file}" target="_blank">${response.output_file}</a>`);
                            $("#webhookLog").html("Webhook Triggered! Output file generated.");
                        } else {
                            $("#statusResult").html(`<b>Status:</b> ${response.status}`);
                        }
                    },
                    error: function () {
                        $("#statusResult").html("Invalid Request ID.");
                    }
                });
            });
        
    </script>

</body>
</html>
